name: Deploy Frontend to Cloud Run
on:
  push:
    branches: main
  workflow_dispatch:

env:
  REGION: us-east1
  SERVICE_NAME: jobhub-frontend
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  IMAGE: us-east1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/jobhub-frontend/frontend:${{ github.sha }}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20', cache: 'npm' }
      - run: npm ci
      - run: npm run build
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGION }}-docker.pkg.dev
          username: _json_key_base64
          password: ${{ secrets.GCP_ARTIFACT_REGISTRY_KEY_B64 }}
      - uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.IMAGE }}
          build-args: |
            VITE_API_BASE_URL=https://api.jobhub.muazr.ca/api/v1
            VITE_JOBS_API_URL=
            VITE_SCRAPE_API_URL=

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_JSON }}
      - uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          image: ${{ env.IMAGE }}
          region: ${{ env.REGION }}
          env_vars: |
            VITE_API_BASE_URL=https://api.jobhub.muazr.ca/api/v1
            PORT=8080
